# MS365D - Alerts & Behaviors

Tables for Microsoft 365 Defender alerts and behavioral analysis.

## Table: AlertInfo

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-alertinfo-table?view=o365-worldwide)

**Description:** Alerts from Microsoft Defender for Endpoint, Microsoft Defender for Office 365, Microsoft Cloud App Security, and Microsoft Defender for Identity, including severity information and threat categorization

### Table Schema:
| Field | Description |
| --- | --- |
| **AlertId** | Unique identifier for the alert |
| **AttackTechniques** | MITRE ATT&CK techniques associated with the activity that triggered the alert |
| **Category** | Type of threat indicator or breach activity identified by the alert |
| **DetectionSource** | Detection technology or sensor that identified the notable component or activity |
| **ServiceSource** | Product or service that provided the alert information |
| **Severity** | Indicates the potential impact (high, medium, or low) of the threat indicator or breach activity identified by the alert |
| **Timestamp** | Date and time when the record was generated |
| **Title** | Title of the alert |

### Examples:

#### Get the number of alerts by MITRE ATT&CK technique
```kql
AlertInfo
| where isnotempty(AttackTechniques)
| mvexpand todynamic(AttackTechniques) to typeof(string)
| summarize AlertCount = dcount(AlertId) by AttackTechniques
| sort by AlertCount desc
```

#### Get the number of alerts by severity
```kql
AlertInfo
| summarize alertsCount=dcount(AlertId) by Severity
| sort by alertsCount desc
```

---

## Table: AlertEvidence

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-alertevidence-table?view=o365-worldwide)

**Description:** Files, IP addresses, URLs, users, or devices associated with alerts

### Table Schema:
| Field | Description |
| --- | --- |
| **AccountDomain** | Domain of the account |
| **AccountName** | User name of the account |
| **AccountObjectId** | Unique identifier for the account in Azure AD |
| **AccountSid** | Security Identifier (SID) of the account |
| **AccountUpn** | User principal name (UPN) of the account |
| **AdditionalFields** | Additional information about the entity or event |
| **AlertId** | Unique identifier for the alert |
| **Application** | Application that performed the recorded action |
| **ApplicationId** | Unique identifier for the application |
| **AttackTechniques** | MITRE ATT&CK techniques associated with the activity that triggered the alert |
| **Categories** | List of categories that the information belongs to, in JSON array format |
| **DetectionSource** | Detection technology or sensor that identified the notable component or activity |
| **DeviceId** | Unique identifier for the device in the service |
| **DeviceName** | Fully qualified domain name (FQDN) of the device |
| **EmailSubject** | Subject of the email |
| **EntityType** | Type of object, such as a file, a process, a device, or a user |
| **EvidenceDirection** | Indicates whether the entity is the source or the destination of a network connection |
| **EvidenceRole** | How the entity is involved in an alert, indicating whether it is impacted or is merely related |
| **FileName** | Name of the file that the recorded action was applied to |
| **FileSize** | Size of the file in bytes |
| **FolderPath** | Folder containing the file that the recorded action was applied to |
| **LocalIP** | IP address assigned to the local machine used during communication |
| **NetworkMessageId** | Unique identifier for the email, generated by Office 365 |
| **OAuthApplicationId** | Unique identifier of the third-party OAuth application |
| **ProcessCommandLine** | Command line used to create the new process |
| **RegistryKey** | Registry key that the recorded action was applied to |
| **RegistryValueData** | Data of the registry value that the recorded action was applied to |
| **RegistryValueName** | Name of the registry value that the recorded action was applied to |
| **RemoteIP** | IP address that was being connected to |
| **RemoteUrl** | URL or fully qualified domain name (FQDN) that was being connected to |
| **ServiceSource** | Product or service that provided the alert information |
| **Severity** | Indicates the potential impact (high, medium, or low) of the threat indicator or breach activity identified by the alert |
| **SHA1** | SHA-1 hash of the file that the recorded action was applied to |
| **SHA256** | SHA-256 of the file that the recorded action was applied to |
| **ThreatFamily** | Malware family that the suspicious or malicious file or process has been classified under |
| **Timestamp** | Date and time when the record was generated |
| **Title** | Title of the alert |

### Examples:

#### List all alerts involving a particular user account
```kql
let userID = "<insert your AAD user ID>";
let userSid = "<insert your user SID>";
AlertEvidence
| where EntityType == "User" and (AccountObjectId == userID or AccountSid == userSid)
| join AlertInfo on AlertId
| project Timestamp, AlertId, Title, Category, Severity, ServiceSource, DetectionSource, AttackTechniques, AccountObjectId, AccountName, AccountDomain, AccountSid
```

#### List all alerts involving a specific device
```kql
let myDevice = "<insert your device ID>";
let deviceName = "<insert your device name>";
AlertEvidence
| extend DeviceName = todynamic(AdditionalFields)["HostName"]
| where EntityType == "Machine" and (DeviceId == myDevice or DeviceName == deviceName)
| project DeviceId, DeviceName, AlertId
| join AlertInfo on AlertId
| project Timestamp, AlertId, Title, Category, Severity, ServiceSource, DetectionSource, AttackTechniques, DeviceId, DeviceName
```

---

## Table: BehaviorInfo

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-behaviorinfo-table?view=o365-worldwide)

**Description:** Contains information about behaviors, which in the context of Microsoft 365 Defender refers to a conclusion or insight based on one or more raw events, which can provide analysts more context in investigations

### Table Schema:
| Field | Description |
| --- | --- |
| **AccountObjectId** | Unique identifier for the account in Azure AD |
| **AccountUpn** | User principal name (UPN) of the account |
| **ActionType** | Type of behavior |
| **AdditionalFields** | Additional information about the behavior |
| **AttackTechniques** | MITRE ATT&CK techniques associated with the activity that triggered the behavior |
| **BehaviorId** | Unique identifier for the behavior |
| **Categories** | Type of threat indicator or breach activity identified by the behavior |
| **DataSources** | Products or services that provided information for the behavior |
| **Description** | Description of behavior |
| **DetectionSource** | Detection technology or sensor that identified the notable component or activity |
| **DeviceId** | Unique identifier for the device in the service |
| **EndTime** | Date and time of the last activity related to the behavior |
| **ServiceSource** | Product or service that identified the behavior |
| **StartTime** | Date and time of the first activity related to the behavior |
| **Timestamp** | Date and time when the record was generated |

### Examples:

#### All behaviors in the last week on users that raised an alert
```kql
AlertEvidence
| where Timestamp > ago(7d)
| where EntityType == 'User'
| distinct AccountObjectId
| join (BehaviorInfo | where Timestamp > ago(7d)) on AccountObjectId
```

#### Get behaviors associated with a specific MITRE ATT&CK technique
```kql
let technique = 'Valid Accounts (T1078)';
BehaviorInfo
| where Timestamp > ago(7d)
| where AttackTechniques has technique
```

---

## Table: BehaviorEntities

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-behaviorentities-table?view=o365-worldwide)

**Description:** Contains information about entities (file, process, device, user, and others) that are involved in a behavior

### Table Schema:
| Field | Description |
| --- | --- |
| **AccountDomain** | Domain of the account |
| **AccountName** | User name of the account |
| **AccountObjectId** | Unique identifier for the account in Azure AD |
| **AccountSid** | Security Identifier (SID) of the account |
| **AccountUpn** | User principal name (UPN) of the account |
| **ActionType** | Type of behavior |
| **AdditionalFields** | Additional information about the behavior |
| **Application** | Application that performed the recorded action |
| **ApplicationId** | Unique identifier for the application |
| **BehaviorId** | Unique identifier for the behavior |
| **Categories** | Type of threat indicator or breach activity identified by the behavior |
| **DataSources** | Products or services that provided information for the behavior |
| **DetailedEntityRole** | The role of the entity in the behavior |
| **DetectionSource** | Detection technology or sensor that identified the notable component or activity |
| **DeviceId** | Unique identifier for the device in the service |
| **DeviceName** | Fully qualified domain name (FQDN) of the device |
| **EmailClusterId** | Identifier for the group of similar emails clustered based on heuristic analysis of their contents |
| **EmailSubject** | Subject of the email |
| **EntityRole** | Indicates whether the entity is impacted or merely related |
| **EntityType** | Type of object, such as a file, a process, a device, or a user |
| **FileName** | Name of the file that the recorded action was applied to |
| **FileSize** | Size of the file in bytes |
| **FolderPath** | Folder containing the file that the recorded action was applied to |
| **LocalIP** | IP address assigned to the local machine used during communication |
| **NetworkMessageId** | Unique identifier for the email, generated by Office 365 |
| **OAuthApplicationId** | Unique identifier of the third-party OAuth application |
| **ProcessCommandLine** | Command line used to create the new process |
| **RegistryKey** | Registry key that the recorded action was applied to |
| **RegistryValueData** | Data of the registry value that the recorded action was applied to |
| **RegistryValueName** | Name of the registry value that the recorded action was applied to |
| **RemoteIP** | IP address that was being connected to |
| **RemoteUrl** | URL or fully qualified domain name (FQDN) that was being connected to |
| **ServiceSource** | Product or service that identified the behavior |
| **SHA1** | SHA-1 hash of the file that the recorded action was applied to |
| **SHA256** | SHA-256 of the file that the recorded action was applied to |
| **ThreatFamily** | Malware family that the suspicious or malicious file or process has been classified under |
| **Timestamp** | Date and time when the record was generated |
