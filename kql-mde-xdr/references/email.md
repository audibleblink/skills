# MDO - Email Security

Tables for Microsoft Defender for Office 365 (MDO) email security.

## Table: EmailEvents

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-emailevents-table?view=o365-worldwide)

**Description:** Office 365 email events, including email delivery and blocking events

### Table Schema:
| Field | Description |
| --- | --- |
| **AdditionalFields** | Additional information about the entity or event |
| **AttachmentCount** | Number of attachments in the email |
| **AuthenticationDetails** | List of pass or fail verdicts by email authentication protocols (DMARC, DKIM, SPF, CompAuth) |
| **BulkComplaintLevel** | Threshold assigned to email from bulk mailers (higher BCL = more likely spam) |
| **ConfidenceLevel** | List of confidence levels of any spam or phishing verdicts |
| **Connectors** | Custom instructions that define organizational mail flow |
| **DeliveryAction** | Delivery action of the email: Delivered, Junked, Blocked, or Replaced |
| **DeliveryLocation** | Location where the email was delivered: Inbox/Folder, On-premises/External, Junk, Quarantine, Failed, Dropped, Deleted items |
| **DetectionMethods** | Methods used to detect malware, phishing, or other threats |
| **EmailAction** | Final action taken on the email based on filter verdict, policies, and user actions |
| **EmailActionPolicy** | Action policy that took effect |
| **EmailActionPolicyGuid** | Unique identifier for the policy that determined the final mail action |
| **EmailClusterId** | Identifier for the group of similar emails clustered based on heuristic analysis |
| **EmailDirection** | Direction of the email: Inbound, Outbound, Intra-org |
| **EmailLanguage** | Detected language of the email content |
| **InternetMessageId** | Public-facing identifier for the email set by the sending email system |
| **NetworkMessageId** | Unique identifier for the email, generated by Office 365 |
| **OrgLevelAction** | Action taken on the email in response to organizational policy matches |
| **OrgLevelPolicy** | Organizational policy that triggered the action |
| **RecipientEmailAddress** | Email address of the recipient |
| **RecipientObjectId** | Unique identifier for the email recipient in Azure AD |
| **ReportId** | Unique identifier for the event |
| **SenderDisplayName** | Name of the sender displayed in the address book |
| **SenderFromAddress** | Sender email address in the FROM header |
| **SenderFromDomain** | Sender domain in the FROM header |
| **SenderIPv4** | IPv4 address of the last detected mail server that relayed the message |
| **SenderIPv6** | IPv6 address of the last detected mail server that relayed the message |
| **SenderMailFromAddress** | Sender email address in the MAIL FROM header (envelope sender) |
| **SenderMailFromDomain** | Sender domain in the MAIL FROM header |
| **SenderObjectId** | Unique identifier for the sender's account in Azure AD |
| **Subject** | Subject of the email |
| **ThreatNames** | Detection name for malware or other threats found |
| **ThreatTypes** | Verdict from the email filtering stack |
| **Timestamp** | Date and time when the record was generated |
| **UrlCount** | Number of embedded URLs in the email |
| **UserLevelAction** | Action taken on the email in response to mailbox policy matches |
| **UserLevelPolicy** | End user mailbox policy that triggered the action |

### Examples:

#### Get the number of phishing emails from the top ten sender domains
```kql
EmailEvents
| where ThreatTypes has "Phish"
| summarize Count = count() by SenderFromDomain
| top 10 by Count
```

#### List all email messages found containing malware
```kql
EmailEvents
| where ThreatTypes has "Malware"
| limit 500
```

---

## Table: EmailAttachmentInfo

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-emailattachmentinfo-table?view=o365-worldwide)

**Description:** Information about files attached to Office 365 emails

### Table Schema:
| Field | Description |
| --- | --- |
| **DetectionMethods** | Methods used to detect malware, phishing, or other threats found in the email |
| **FileName** | Name of the file that the recorded action was applied to |
| **FileSize** | Size of the file in bytes |
| **FileType** | File extension type |
| **NetworkMessageId** | Unique identifier for the email, generated by Office 365 |
| **RecipientEmailAddress** | Email address of the recipient |
| **RecipientObjectId** | Unique identifier for the email recipient in Azure AD |
| **ReportId** | Unique identifier for the event |
| **SenderDisplayName** | Name of the sender displayed in the address book |
| **SenderFromAddress** | Sender email address in the FROM header |
| **SenderObjectId** | Unique identifier for the sender's account in Azure AD |
| **SHA256** | SHA-256 of the file that the recorded action was applied to |
| **ThreatNames** | Detection name for malware or other threats found |
| **ThreatTypes** | Verdict from the email filtering stack |
| **Timestamp** | Date and time when the record was generated |

### Examples:

#### Find the appearance of files sent by a malicious sender on devices
```kql
let MaliciousSender = "<insert the sender email address>";
EmailAttachmentInfo
| where Timestamp > ago(7d)
| where SenderFromAddress =~ MaliciousSender
| project SHA256 = tolower(SHA256)
| join (
    DeviceFileEvents
    | where Timestamp > ago(7d)
) on SHA256
| summarize FirstAppearance = min(Timestamp) by DeviceName, SHA256, FileName
```

#### List all email messages with attachments sent to external domains
```kql
EmailEvents
| where EmailDirection == "Outbound" and AttachmentCount > 0
| join EmailAttachmentInfo on NetworkMessageId
| project Timestamp, Subject, SenderFromAddress, RecipientEmailAddress, NetworkMessageId, FileName, AttachmentCount
| take 100
```

---

## Table: EmailUrlInfo

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-emailurlinfo-table?view=o365-worldwide)

**Description:** Information about URLs on Office 365 emails

### Table Schema:
| Field | Description |
| --- | --- |
| **NetworkMessageId** | Unique identifier for the email, generated by Office 365 |
| **ReportId** | Unique identifier for the event |
| **Timestamp** | Date and time when the record was generated |
| **Url** | Full URL from email |
| **UrlDomain** | Domain name or host name of the URL |
| **UrlLocation** | Indicates which part of the email the URL is located |

### Examples:

#### List all URLs in the body of a specific email
```kql
let myEmailId = "<insert your email NetworkMessageId>";
EmailEvents
| where NetworkMessageId == myEmailId
| join EmailUrlInfo on NetworkMessageId
| project Timestamp, Subject, SenderFromAddress, RecipientEmailAddress, NetworkMessageId, Url, UrlCount
```

---

## Table: EmailPostDeliveryEvents

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-emailpostdeliveryevents-table?view=o365-worldwide)

**Description:** Security events that occur post-delivery, after Office 365 has delivered an email message to the recipient mailbox

### Table Schema:
| Field | Description |
| --- | --- |
| **Action** | Action taken on the entity |
| **ActionResult** | Result of the action |
| **ActionTrigger** | Indicates whether an action was triggered by an administrator or by some special mechanism (ZAP, Dynamic Delivery) |
| **ActionType** | Type of activity that triggered the event |
| **DeliveryLocation** | Location where the email was delivered |
| **DetectionMethods** | Methods used to detect malware, phishing, or other threats |
| **InternetMessageId** | Public-facing identifier for the email |
| **NetworkMessageId** | Unique identifier for the email, generated by Office 365 |
| **RecipientEmailAddress** | Email address of the recipient |
| **ReportId** | Unique identifier for the event |
| **ThreatTypes** | Verdict from the email filtering stack |
| **Timestamp** | Date and time when the record was generated |

### ActionTypes:
| ActionType | Description |
| --- | --- |
| **Malware ZAP** | Zero-hour auto purge (ZAP) took action on an email containing malware after delivery |
| **Manual Remediation** | An administrator manually took action on an email after delivery |
| **Phish ZAP** | Zero-hour auto purge (ZAP) took action on a phishing email after delivery |
| **Spam ZAP** | Zero-hour auto purge (ZAP) took action on spam email after delivery |

### Examples:

#### Find unremediated emails that were identified as phishing after delivery
```kql
EmailPostDeliveryEvents
| where ActionType == 'Phish ZAP' and ActionResult == 'Error'
| join EmailEvents on NetworkMessageId, RecipientEmailAddress
```

#### Get detailed processing information for a specific email
```kql
let mySender = "<insert sender email address>";
let subject = "<insert email subject>";
EmailEvents
| where SenderFromAddress == mySender and Subject == subject
| join EmailPostDeliveryEvents on NetworkMessageId, RecipientEmailAddress
```

#### List all actions taken or approved by administrators manually on emails after delivery
```kql
EmailPostDeliveryEvents
| where ActionTrigger == 'AdminAction'
| limit 100
```

---

## Table: UrlClickEvents

[Link to Microsoft](https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-urlclickevents-table?view=o365-worldwide)

**Description:** Events involving URLs clicked, selected, or requested on Microsoft Defender for Office 365

### Table Schema:
| Field | Description |
| --- | --- |
| **AccountUpn** | User principal name (UPN) of the account |
| **ActionType** | Type of activity that triggered the event |
| **DetectionMethods** | Methods used to detect whether the URL contains or leads to threats |
| **IPAddress** | IP address assigned to the device during communication |
| **IsClickedThrough** | Indicates whether the user was able to click through to the original URL |
| **NetworkMessageId** | Unique identifier for the email from which the URL was clicked |
| **ReportId** | Unique identifier for the event |
| **ThreatTypes** | Verdict on whether the URL leads to malware, phishing, or other threats |
| **Timestamp** | Date and time when the record was generated |
| **Url** | URL that was clicked |
| **UrlChain** | List of URLs in the redirection chain |
| **Workload** | Information about the workload from which the URL originated |

### ActionTypes:
| ActionType | Description |
| --- | --- |
| **ClickAllowed** | The user was allowed to navigate to the URL |
| **ClickBlocked** | The user was blocked from navigating to the URL |
| **ClickBlockedByTenantPolicy** | The user was blocked from navigating to the URL by a tenant policy |
| **UrlErrorPage** | The URL the user clicked showed an error page |
| **UrlScanInProgress** | The URL the user clicked is being scanned by Safe Links |
